<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SPS DApp - Ultra Premium</title>

<!-- ethers.js (unchanged logic) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<style>
  /* ----------------- Theme (Premium Elegant) ----------------- */
  :root{
    --bg-1: #040615;
    --bg-2: #071029;
    --glass: rgba(255,255,255,0.03);
    --card: rgba(255,255,255,0.02);
    --muted: #9fb3cf;
    --primary: #3b82f6;
    --accent: #8b5cf6;
    --neon: #00ffd5;
    --neon-2: #7c3aed;
    --success: #10b981;
    --danger: #ef4444;
    --glass-border: rgba(255,255,255,0.04);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html[dir="rtl"]{ direction: rtl; }
  html[dir="ltr"]{ direction: ltr; }

  body{
    font-family: Inter, "Segoe UI", Tahoma, Arial, sans-serif;
    background:
      radial-gradient(800px 320px at 10% 10%, rgba(139,92,246,0.04), transparent),
      radial-gradient(700px 280px at 90% 90%, rgba(0,255,213,0.02), transparent),
      linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
    color: #e6eef8;
    min-height:100vh;
    padding:20px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }

  /* ---------- Canvas layers (neural wave + particles + confetti) ---------- */
  #neuralWave {
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
    background: radial-gradient(40% 25% at 10% 20%, rgba(124,58,237,0.03), transparent),
                radial-gradient(30% 20% at 90% 80%, rgba(0,255,213,0.02), transparent);
    mix-blend-mode: screen;
  }
  #neonParticles, #confetti { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
  #confetti { z-index: 10000; display:none; }

  /* ---------- Container ---------- */
  .container{ max-width:1200px; margin:0 auto; position:relative; z-index:5; }

  /* ---------- Header ---------- */
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px; padding:14px; border:1px solid var(--glass-border);
    box-shadow: 0 12px 40px rgba(11,26,43,0.6);
    position:relative; overflow:hidden;
    backdrop-filter: blur(6px) saturate(120%);
  }

  /* ---------- Logo: SVG + flip to $ ---------- */
  .logo-3d{ width:96px; height:46px; perspective:1000px; display:flex; align-items:center; justify-content:center; }
  .logo-card{
    width:96px; height:46px; display:flex; align-items:center; justify-content:center;
    border-radius:10px; position:relative; transform-style:preserve-3d;
    transition: transform 0.7s cubic-bezier(.2,.9,.3,1);
  }
  .logo-face{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    backface-visibility: hidden; -webkit-backface-visibility: hidden;
    transform-style: preserve-3d;
  }
  .logo-face.front svg { width:78px; height:28px; }
  .logo-face.back { transform: rotateY(180deg); font-weight:900; font-size:20px; color:var(--neon); text-shadow: 0 0 12px rgba(0,255,213,0.18), 0 0 36px rgba(124,58,237,0.06); }

  .logo-glow {
    position:absolute; inset:-20%; z-index:-1; filter: blur(28px); opacity:0.6;
    background: radial-gradient(circle at 20% 30%, rgba(59,130,246,0.12), transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(124,58,237,0.10), transparent 20%),
                radial-gradient(circle at 50% 50%, rgba(0,255,213,0.06), transparent 30%);
    border-radius:14px;
  }
  /* pulsing subtle glow */
  @keyframes logoPulse { 0%{ transform:scale(0.985) } 50%{ transform:scale(1.02) } 100%{ transform:scale(0.985) } }
  .logo-card.pulse { animation: logoPulse 3.6s ease-in-out infinite; }

  /* ---------- Status / language ---------- */
  .status-ind{ display:flex; gap:10px; align-items:center }
  .status-dot{ width:12px; height:12px; border-radius:50%; background:var(--danger); box-shadow:0 0 10px rgba(239,68,68,0.2) }
  .status-dot.connected{ background:var(--success); box-shadow:0 0 18px rgba(16,185,129,0.14) }
  .network-text{ font-weight:700; color:var(--muted) }

  .lang-switch{ display:flex; gap:8px; align-items:center }
  .lang-btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); cursor:pointer; background:transparent; color:var(--muted); font-weight:700 }
  .lang-btn.active{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:#041426; box-shadow:0 8px 26px rgba(59,130,246,0.12) }

  /* ---------- Tabs ---------- */
  .tabs{ display:flex; gap:8px; margin:16px 0; flex-wrap:wrap; z-index:5; }
  .tab-btn{ padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.02); color:var(--muted); cursor:pointer; font-weight:700 }
  .tab-btn.active{ background: linear-gradient(90deg, rgba(59,130,246,0.12), rgba(139,92,246,0.06)); color:var(--primary); box-shadow: 0 10px 30px rgba(59,130,246,0.06) }

  /* ---------- Stats / Cards (Glassmorphism + cinematic shadows) ---------- */
  .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; margin:14px 0; z-index:5; }
  .stat-box{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:16px; border-radius:14px; border:1px solid var(--glass-border);
    box-shadow: 0 12px 30px rgba(2,8,20,0.6), inset 0 1px 0 rgba(255,255,255,0.01);
    position:relative; overflow:hidden; backdrop-filter: blur(6px) saturate(120%);
    transition: transform .36s ease, box-shadow .36s ease;
  }
  .stat-box:hover { transform: translateY(-8px); box-shadow: 0 28px 60px rgba(11,26,43,0.7); }
  .stat-label{ color:var(--muted); font-size:13px; margin-bottom:8px; }
  .stat-value{ font-size:18px; font-weight:900; color:#dff5ff; text-shadow: 0 6px 18px rgba(59,130,246,0.06); }

  /* fancy border accent */
  .stat-box:after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background: linear-gradient(90deg, rgba(59,130,246,0.06), rgba(124,58,237,0.04));
    mix-blend-mode: screen; border-radius:14px; opacity:0.3;
  }

  /* ---------- Tree ---------- */
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:12px; z-index:5; }
  .card{ padding:14px; border-radius:12px; border:1px solid var(--glass-border); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); box-shadow: 0 12px 30px rgba(5,10,25,0.6); backdrop-filter: blur(6px) }
  .tree-container{ max-height:540px; overflow:auto; padding:12px; border-radius:10px; }
  .node{ padding:12px; border-radius:10px; margin-bottom:12px; background: rgba(12,16,28,0.6); border:1px solid rgba(59,130,246,0.06); display:flex; justify-content:space-between; align-items:center; gap:12px; transition: transform .28s, box-shadow .28s; }
  .node:hover{ transform: translateY(-6px); box-shadow: 0 16px 40px rgba(44,95,227,0.06); }
  .meta{ color:var(--muted); font-size:13px; }

  .toggle-btn{ background:transparent;border:1px solid rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; color:var(--primary); cursor:pointer; font-weight:700 }

  /* ---------- Buttons ---------- */
  .btn{ padding:12px; border-radius:10px; border:none; cursor:pointer; font-weight:800 }
  .btn-primary{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:white; box-shadow: 0 12px 30px rgba(59,130,246,0.08); }
  .btn-success{ background: linear-gradient(90deg,var(--success),#34d399); color:#031612; }
  .btn-danger{ background: linear-gradient(90deg,var(--danger),#f87171); color:#2b0e0e; }
  .btn.disabled{ opacity:0.45; pointer-events:none; filter:grayscale(0.4) }

  .btn-group{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px }

  /* ---------- Countdown (premium look) ---------- */
  .countdown{ display:flex; align-items:center; gap:12px; justify-content:center; padding:12px; border-radius:12px; background: linear-gradient(90deg, rgba(59,130,246,0.04), rgba(124,58,237,0.03)); border:1px solid rgba(255,255,255,0.02); box-shadow: 0 12px 30px rgba(11,26,43,0.6); font-weight:900; }
  .time-segment{ display:flex; flex-direction:column; align-items:center; padding:8px 12px; border-radius:8px; background: rgba(255,255,255,0.01); min-width:64px; }
  .time-value{ font-size:18px; color:#e6f8ff; font-weight:900; text-shadow:0 8px 20px rgba(59,130,246,0.08) }
  .time-label{ color:var(--muted); font-size:12px; }

  /* ---------- Loading ---------- */
  .loading{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center }
  .spinner{ width:80px; height:80px; border-radius:50%; border:6px solid rgba(255,255,255,0.04); border-top-color:var(--neon); animation: spin 1s linear infinite; }
  @keyframes spin{ to{ transform: rotate(360deg) } }

  /* ---------- Footer ---------- */
  footer{ margin-top:20px; text-align:center; color:var(--muted); font-size:13px; z-index:5; position:relative; }

  /* responsive */
  @media (max-width:980px){ .grid-2{ grid-template-columns:1fr } .header{ flex-direction:column; align-items:flex-start } .logo-3d{ margin-bottom:8px } }
</style>
</head>
<body>
  <!-- Canvas layers -->
  <div id="neuralWave"></div>
  <canvas id="neonParticles"></canvas>
  <canvas id="confetti"></canvas>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div style="display:flex;align-items:center;gap:14px">
        <div class="logo-3d" aria-hidden="true">
          <div id="logoCard" class="logo-card pulse" role="img" aria-label="SPS">
            <div class="logo-face front" id="logoFront">
              <!-- SVG SPS logo (guaranteed render) -->
              <svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <defs>
                  <linearGradient id="g1" x1="0" x2="1">
                    <stop offset="0" stop-color="#3b82f6"/>
                    <stop offset="1" stop-color="#8b5cf6"/>
                  </linearGradient>
                  <filter id="neon" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur stdDeviation="6" result="b"/>
                    <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                  </filter>
                </defs>
                <g filter="url(#neon)">
                  <!-- Big bold SPS text drawn as vector using <text> (safe fallback) -->
                  <text x="50%" y="55%" text-anchor="middle" font-family="Inter, Tahoma, Arial" font-weight="800" font-size="36" fill="url(#g1)" style="letter-spacing:2px">SPS</text>
                </g>
              </svg>
            </div>
            <div class="logo-face back" id="logoBack" aria-hidden="true">
              $ 
            </div>
            <div class="logo-glow" aria-hidden="true"></div>
          </div>
        </div>

        <div class="status-ind" aria-hidden="true">
          <div id="statusDot" class="status-dot"></div>
          <div id="networkStatus" class="network-text">Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="lang-switch" role="tablist" aria-label="Language switch">
          <button id="btn-fa" class="lang-btn">FA</button>
          <button id="btn-en" class="lang-btn">EN</button>
        </div>
        <div id="connectArea">
          <button id="connectBtn" class="btn-primary btn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsRow">
      <button class="tab-btn active" onclick="showTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
      <button class="tab-btn" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
      <button class="tab-btn" onclick="showTab('miner')">Ù…Ø§ÛŒÙ†Ø±</button>
      <button class="tab-btn" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" onclick="showTab('admin')" id="adminTab" style="display:none">Ù…Ø¯ÛŒØ±ÛŒØª</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboardTab">
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label" id="label-poolBalance">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±</div>
          <div class="stat-value" id="poolBalance">0 MATIC</div>
        </div>

        <div class="stat-box">
          <div class="stat-label" id="label-minerPool">Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±</div>
          <div class="stat-value" id="minerPool">0 pToken</div>
        </div>

        <div class="stat-box">
          <div class="stat-label" id="label-specialPool">Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</div>
          <div class="stat-value" id="specialPool">0 MATIC</div>
        </div>

        <div class="stat-box">
          <div class="stat-label" id="label-entryFee">Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯</div>
          <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 id="h-userinfo">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
          <div id="userInfo" class="status info">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</div>
          <div class="help" id="help-userinfo">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ù„ÛŒÙ†Ú© ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
        </div>

        <div class="card">
          <h3 id="h-tree">ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø´Ù…Ø§</h3>
          <div class="tree-container" id="treeContainer">
            <div class="node">ğŸ”„ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯</div>
          </div>
          <div class="help" id="help-tree">Ø±ÙˆÛŒ Ù‡Ø± Ú¯Ø±Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù† ØªØ§ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ø´ÙˆÙ†Ø¯ â€” Left/Right IDs Ú©Ù†Ø§Ø± Ù‡Ø± Ú¯Ø±Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>
      </div>
    </div>

    <!-- Register -->
    <div id="registerTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3 id="h-register">ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
          <div class="form-group">
            <label class="form-label" id="label-upline">Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†</label>
            <input id="uplineCode" class="form-input" type="number" placeholder="1"/>
          </div>
          <div class="form-group">
            <label class="form-label" id="label-position">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
            <select id="position" class="form-input">
              <option value="true">Ú†Ù¾</option>
              <option value="false">Ø±Ø§Ø³Øª</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="register()" id="btn-register">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
          <div id="registerResult"></div>
        </div>

        <div class="card">
          <h3 id="h-reginfo">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
          <div id="registerInfo" class="status info">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
        </div>
      </div>
    </div>

    <!-- Miner -->
    <div id="minerTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3 id="h-miner">â›ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
          <div class="form-group">
            <label class="form-label" id="label-contribution">Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)</label>
            <input id="contribution" class="form-input" placeholder="0.1"/>
          </div>

          <div class="btn-group">
            <button class="btn btn-success" onclick="contribute()" id="btn-contrib">Ù…Ø´Ø§Ø±Ú©Øª</button>
            <button class="btn btn-primary" onclick="buyTokens()" id="btn-buy">Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±</button>
            <button class="btn btn-success" onclick="distribute()" id="btn-distrib">ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</button>
          </div>

          <div id="minerResult"></div>
        </div>

        <div class="card">
          <h3 id="h-minerinfo">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
          <div id="minerInfo" class="status info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§</div>
        </div>
      </div>
    </div>

    <!-- Actions (timers moved here) -->
    <div id="actionsTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3 id="h-actions">ğŸ’¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>

          <div class="countdown" style="margin-bottom:12px">
            <div style="font-weight:700;margin-right:12px" id="poolTimerLabel">Ø§Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª</div>
            <div id="poolTimerSegments" style="display:flex;gap:6px"></div>
          </div>

          <div class="countdown" style="margin-bottom:12px">
            <div style="font-weight:700;margin-right:12px" id="specialTimerLabel">Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ</div>
            <div id="specialTimerSegments" style="display:flex;gap:6px"></div>
          </div>

          <div class="btn-group" style="margin-top:10px">
            <button id="withdrawMainBtn" class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ</button>
            <button id="withdrawSpecialBtn" class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</button>
          </div>

          <div id="withdrawResult" style="margin-top:12px"></div>
        </div>

        <div class="card">
          <h3 id="h-withdrawinfo">ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
          <div id="withdrawInfo" class="status info">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</div>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3 id="h-admin">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
          <div class="form-group">
            <label class="form-label" id="label-newFee">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ (wei)</label>
            <input id="newFee" class="form-input" placeholder="300000000000000000000"/>
          </div>
          <button class="btn btn-danger" onclick="updateFee()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯</button>
          <div id="adminResult"></div>
        </div>

        <div class="card">
          <h3 id="h-admin2">ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</h3>
          <div class="form-group">
            <label class="form-label" id="label-addresses">Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§)</label>
            <textarea id="addresses" class="form-input" rows="4" placeholder="0x123...,0x456..."></textarea>
          </div>
          <button class="btn btn-danger" onclick="removeMiners()">Ø­Ø°Ù Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</button>
        </div>
      </div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div></div>

    <footer id="footerText">SPS Network â€¢ Contract: 0x7a7b06D49129B34976D07B3854d4D72D01588191 â€¢ Polygon Mainnet</footer>
  </div>

<script>
/* ================= TRANSLATIONS (Professional A) ================= */
const translations = {
  fa: { dashboard:"Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯", register:"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…", miner:"Ù…Ø§ÛŒÙ†Ø±", actions:"Ø¹Ù…Ù„ÛŒØ§Øª", admin:"Ù…Ø¯ÛŒØ±ÛŒØª",
        connect_wallet:"Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„", pool_balance:"Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±", miner_pool:"Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±",
        special_pool:"Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡", entry_fee:"Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯", user_info:"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ",
        tree_title:"Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø´Ù…Ø§", register_label:"Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†", position:"Ù…ÙˆÙ‚Ø¹ÛŒØª",
        contribution:"Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)", buy_miner:"Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±", distribute:"ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§",
        withdraw_pool:"Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ", withdraw_special:"Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡",
        last_pool_label:"Ø§Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª", special_label:"Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ",
        registration_fee_text:"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)", miner_info:"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§",
        pool_timer_title:"Ø²Ù…Ø§Ù† ØªØ§ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø¹Ø¯ÛŒ Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ" },
  en: { dashboard:"Dashboard", register:"Register", miner:"Miner", actions:"Operations", admin:"Admin",
        connect_wallet:"Connect Wallet", pool_balance:"Pool Balance", miner_pool:"Miner Pool",
        special_pool:"Special Reward", entry_fee:"Entry Fee", user_info:"User Info",
        tree_title:"Your Tree Structure", register_label:"Upline Code", position:"Position",
        contribution:"Contribution (MATIC)", buy_miner:"Buy Miner Token", distribute:"Distribute Tokens",
        withdraw_pool:"Withdraw Main Pool", withdraw_special:"Withdraw Special",
        last_pool_label:"Last Withdraw", special_label:"Next Special Withdraw",
        registration_fee_text:"Register (300 MATIC)", miner_info:"Your Miner Info",
        pool_timer_title:"Time until next main-pool withdraw" }
};
let lang = localStorage.getItem('sps_lang') || 'fa';
function t(k){ return translations[lang] && translations[lang][k] ? translations[lang][k] : k; }

/* ================= CONSTANTS + ABI (NO LOGIC CHANGES) ================= */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
const POLYGON_CHAIN_ID = "0x89";
const ENTRY_FEE = "300000000000000000000"; // 300 MATIC

const CONTRACT_ABI = [
  /* ABI unchanged - same functions as before */
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},
  {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"eligibleSpecialUserCount","stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"specialPointCount","stateMutability":"view","type":"function"},
  {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

/* ================= STATE ================= */
let provider, signer, contract, userAddress, isOwner=false;

/* ================= UI HELPERS ================= */
function showStatus(message, type='info', targetId='userInfo'){
  const el = document.getElementById(targetId);
  if(!el) return console.log('missing target', targetId);
  el.className = `status ${type}`;
  el.innerHTML = message;
  console.log(`[${type.toUpperCase()}] ${message.replace(/<[^>]*>/g,'')}`);
}
function showLoading(show){ const el = document.getElementById('loading'); if(el) el.style.display = show ? 'flex' : 'none'; }
function showPending(txHash, targetId){
  const link = `https://polygonscan.com/tx/${txHash}`;
  const el = document.getElementById(targetId);
  if(el) el.innerHTML = `<div class="status info">â³ Transaction sent â€” pending...<div style="margin-top:8px"><a href="${link}" target="_blank" class="tx-link">View on Polygonscan</a></div></div>`;
}
function showTransactionLink(txHash, targetId){
  const link = `https://polygonscan.com/tx/${txHash}`;
  const el = document.getElementById(targetId);
  if(el) el.innerHTML = `<div class="status success">âœ… Transaction mined<div style="margin-top:8px"><a href="${link}" target="_blank" class="tx-link">View on Polygonscan</a></div></div>`;
}

/* ================= Confetti (visual) ================= */
const confettiCanvas = document.getElementById('confetti');
const confettiCtx = confettiCanvas.getContext ? confettiCanvas.getContext('2d') : null;
let confettiPieces = [];
function resizeConfetti(){ if(confettiCanvas){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; } }
window.addEventListener('resize', resizeConfetti);
function spawnConfetti(){
  if(!confettiCtx) return;
  confettiCanvas.style.display = 'block';
  for(let i=0;i<120;i++){
    confettiPieces.push({ x: Math.random()*confettiCanvas.width, y: -Math.random()*confettiCanvas.height, vx:(Math.random()-0.5)*6, vy:2+Math.random()*6, size:6+Math.random()*8, color:['#3b82f6','#8b5cf6','#00ffd5','#ffb86b'][Math.floor(Math.random()*4)], rot:Math.random()*360, rotV:(Math.random()-0.5)*10 });
  }
  let anim;
  function draw(){
    confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
    confettiPieces.forEach((p,i)=>{
      confettiCtx.save();
      confettiCtx.translate(p.x,p.y);
      confettiCtx.rotate(p.rot*Math.PI/180);
      confettiCtx.fillStyle = p.color;
      confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
      confettiCtx.restore();
      p.x += p.vx; p.y += p.vy; p.rot += p.rotV;
      if(p.y > confettiCanvas.height+50){ confettiPieces.splice(i,1); }
    });
    if(confettiPieces.length>0) requestAnimationFrame(draw);
    else { confettiCanvas.style.display='none'; }
  }
  draw();
}

/* ================= Neon Particles (premium, optimized) ================= */
const neonCanvas = document.getElementById('neonParticles');
const neonCtx = neonCanvas.getContext ? neonCanvas.getContext('2d') : null;
let neonParticles = [];
function resizeNeon(){ if(neonCanvas){ neonCanvas.width = window.innerWidth; neonCanvas.height = window.innerHeight; } }
window.addEventListener('resize', resizeNeon);

function initNeonParticles(count=70){
  neonParticles = [];
  for(let i=0;i<count;i++){
    neonParticles.push({
      x: Math.random()*window.innerWidth,
      y: Math.random()*window.innerHeight,
      r: 1 + Math.random()*3,
      vx: (Math.random()-0.5)*0.25,
      vy: (Math.random()-0.5)*0.45,
      hue: 200 + Math.random()*120,
      alpha: 0.06 + Math.random()*0.24,
      pulse: Math.random()*2 + 0.8,
      t: Math.random()*1000
    });
  }
}
function drawNeon(){
  if(!neonCtx) return;
  neonCtx.clearRect(0,0,neonCanvas.width, neonCanvas.height);
  neonParticles.forEach(p=>{
    p.t += 0.01;
    p.x += p.vx + Math.sin(p.t*0.4)*0.15;
    p.y += p.vy + Math.cos(p.t*0.3)*0.12;
    if(p.x < -60) p.x = neonCanvas.width + 60;
    if(p.x > neonCanvas.width + 60) p.x = -60;
    if(p.y < -60) p.y = neonCanvas.height + 60;
    if(p.y > neonCanvas.height + 60) p.y = -60;

    const glowR = p.r*8 + Math.abs(Math.sin(p.t))*6;
    const g = neonCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, glowR*1.6);
    g.addColorStop(0, `hsla(${p.hue},100%,65%,${p.alpha})`);
    g.addColorStop(1, `hsla(${(p.hue+40)%360},80%,55%,${p.alpha*0.06})`);
    neonCtx.fillStyle = g;
    neonCtx.beginPath();
    neonCtx.arc(p.x, p.y, glowR, 0, Math.PI*2);
    neonCtx.fill();

    neonCtx.fillStyle = `hsla(${p.hue},100%,70%,0.9)`;
    neonCtx.beginPath();
    neonCtx.arc(p.x, p.y, p.r*(1+Math.abs(Math.sin(p.t))*0.6), 0, Math.PI*2);
    neonCtx.fill();
  });
  requestAnimationFrame(drawNeon);
}

/* initialize visuals */
function startVisuals(){ resizeConfetti(); resizeNeon(); initNeonParticles(70); drawNeon(); }

/* ================= Language switcher (full FA/EN) ================= */
document.getElementById('btn-fa').onclick = ()=>{
  lang = 'fa'; localStorage.setItem('sps_lang','fa');
  document.getElementById('btn-fa').classList.add('active'); document.getElementById('btn-en').classList.remove('active');
  setLanguage();
};
document.getElementById('btn-en').onclick = ()=>{
  lang = 'en'; localStorage.setItem('sps_lang','en');
  document.getElementById('btn-en').classList.add('active'); document.getElementById('btn-fa').classList.remove('active');
  setLanguage();
};
if(lang==='fa') document.getElementById('btn-fa').classList.add('active'); else document.getElementById('btn-en').classList.add('active');

function setLanguage(){
  document.documentElement.setAttribute('dir', lang==='en' ? 'ltr' : 'rtl');
  const tabBtns = document.querySelectorAll('.tab-btn');
  if(lang==='fa'){ tabBtns[0].textContent = translations.fa.dashboard; tabBtns[1].textContent = translations.fa.register; tabBtns[2].textContent = translations.fa.miner; tabBtns[3].textContent = translations.fa.actions; tabBtns[4].textContent = translations.fa.admin; }
  else { tabBtns[0].textContent = translations.en.dashboard; tabBtns[1].textContent = translations.en.register; tabBtns[2].textContent = translations.en.miner; tabBtns[3].textContent = translations.en.actions; tabBtns[4].textContent = translations.en.admin; }
  document.getElementById('connectBtn').textContent = t('connect_wallet');
  document.getElementById('label-poolBalance').textContent = t('pool_balance');
  document.getElementById('label-minerPool').textContent = t('miner_pool');
  document.getElementById('label-specialPool').textContent = t('special_pool');
  document.getElementById('label-entryFee').textContent = t('entry_fee');
  document.getElementById('h-userinfo').textContent = t('user_info');
  document.getElementById('h-tree').textContent = t('tree_title');
  document.getElementById('label-upline').textContent = t('register_label');
  document.getElementById('label-position').textContent = t('position');
  document.getElementById('btn-register').textContent = t('registration_fee_text');
  document.getElementById('label-contribution').textContent = t('contribution');
  document.getElementById('btn-buy').textContent = t('buy_miner');
  document.getElementById('btn-distrib').textContent = t('distribute');
  document.getElementById('poolTimerLabel').textContent = `${t('last_pool_label')}:`;
  document.getElementById('specialTimerLabel').textContent = t('special_label');
  document.getElementById('h-actions').textContent = (lang==='en' ? 'Operations' : 'Ø¹Ù…Ù„ÛŒØ§Øª');
  document.getElementById('footerText').textContent = lang==='en' ? `SPS Network â€¢ Contract: ${CONTRACT_ADDRESS} â€¢ Polygon Mainnet` : `SPS Network â€¢ Contract: ${CONTRACT_ADDRESS} â€¢ Polygon Mainnet`;
}

/* ================= TX handler (unchanged logic) ================= */
async function handleTx(txPromise, targetId){
  try{
    showLoading(true);
    const tx = await txPromise;
    showPending(tx.hash, targetId);
    const receipt = await tx.wait();
    showTransactionLink(tx.hash, targetId);
    spawnConfetti();
    return receipt;
  }catch(err){
    const el = document.getElementById(targetId);
    if(el) el.innerHTML = `<div class="status error">âŒ ${err.message}</div>`;
    throw err;
  }finally{ showLoading(false); }
}

/* ================= Tree: show Left/Right IDs + counts (unchanged logic) ================= */
async function buildTreeHtml(nodeId, depth=0, maxDepth=6){
  try{
    if(depth > maxDepth) return '';
    const info = await contract._getSpecialUserInfoForMigrateToNewFork(nodeId).catch(()=>null);
    const directs = await contract.getUserDirects(nodeId).catch(()=>[0,0]);
    const leftId = directs[0] ? Number(directs[0]) : 0;
    const rightId = directs[1] ? Number(directs[1]) : 0;
    let leftCount=0, rightCount=0;
    if(info){ leftCount = info[2] ? Number(info[2]) : 0; rightCount = info[3] ? Number(info[3]) : 0; }
    let html = `<div class="node" data-id="${nodeId}" style="margin-${document.documentElement.dir==='rtl'?'right':'left'}:${depth*12}px">`;
    html += `<div style="display:flex;flex-direction:column;gap:6px"><div style="font-weight:800">${lang==='en'?'User #':'Ú©Ø§Ø±Ø¨Ø± #'}${nodeId}</div>`;
    html += `<div class="meta">${lang==='en'?'Left:':'Ú†Ù¾:'} ${leftId?('#'+leftId):'â€”'}  |  ${lang==='en'?'Right:':'Ø±Ø§Ø³Øª:'} ${rightId?('#'+rightId):'â€”'}</div>`;
    html += `<div class="meta">${lang==='en'?'L Count':'Ú†Ù¾'}: ${leftCount}  |  ${lang==='en'?'R Count':'Ø±Ø§Ø³Øª'}: ${rightCount}  |  ${lang==='en'?'Total':'Ø¬Ù…Ø¹'}: ${leftCount+rightCount}</div>`;
    html += `</div>`;
    if(leftId>0 || rightId>0) html += `<div><button class="toggle-btn" data-target="${nodeId}">${lang==='en'?'[toggle]':'[Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡]'}</button></div>`;
    html += `</div>`;
    if(leftId>0 || rightId>0){
      html += `<div class="children" id="children-${nodeId}" style="display:none">`;
      if(leftId>0) html += await buildTreeHtml(leftId, depth+1, maxDepth);
      if(rightId>0) html += await buildTreeHtml(rightId, depth+1, maxDepth);
      html += `</div>`;
    }
    return html;
  }catch(e){
    console.error('buildTreeHtml error', e);
    return `<div class="node">âš ï¸ ${lang==='en'?'Error loading node':'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ø±Ù‡'} ${nodeId}</div>`;
  }
}
async function loadTreeStructure(userId){
  const container = document.getElementById('treeContainer');
  container.innerHTML = `<div class="node">ğŸ”„ ${lang==='en'?'Loading tree...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø±...'}</div>`;
  try{
    const html = await buildTreeHtml(userId);
    container.innerHTML = html || `<div class="node">ğŸ“­ ${lang==='en'?'No descendants':'Ù‡ÛŒÚ† Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'}</div>`;
    container.querySelectorAll('.toggle-btn').forEach(btn=>{
      btn.onclick = ()=>{
        const id = btn.getAttribute('data-target');
        const el = document.getElementById('children-'+id);
        if(!el) return;
        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
      };
    });
  }catch(err){ console.error('loadTreeStructure error', err); container.innerHTML = `<div class="node">âš ï¸ ${lang==='en'?'Tree load error':'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø±'}</div>`; }
}

/* ================ PRE-CHECKS BEFORE WITHDRAW ================ */
async function canWithdrawPool(){
  try{
    if(!contract) return {ok:false, reason: lang==='en' ? 'Contract not initialized' : 'Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª'};
    const withdrawable = await contract.isPoolWithdrawable().catch(()=>false);
    if(!withdrawable) return {ok:false, reason: lang==='en' ? 'Pool is not withdrawable now' : 'Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª'};
    const poolBal = await contract.poolBalance().catch(()=>0);
    if(Number(poolBal) === 0) return {ok:false, reason: lang==='en' ? 'Pool balance is zero' : 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø± ØµÙØ± Ø§Ø³Øª'};
    const eligibleCount = await contract.eligiblePoolUserCount().catch(()=>0);
    if(Number(eligibleCount) === 0) return {ok:false, reason: lang==='en' ? 'No eligible users in this pool' : 'Ø¯Ø± Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ù†ÛŒØ³Øª'};
    return {ok:true, reason: ''};
  }catch(e){ console.error('canWithdrawPool error', e); return {ok:false, reason: lang==='en' ? 'Pre-check failed' : 'Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯'}; }
}

/* ================ CORE ACTIONS (unchanged logic) ================ */
async function register(){ 
  const uplineCode = document.getElementById('uplineCode').value; 
  const position = document.getElementById('position').value === 'true'; 
  if(!uplineCode){ alert(lang==='en'?'Please enter upline code':'Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; } 
  try{ showStatus('ğŸ”„ '+(lang==='en'?'Registering...':'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...'), 'info', 'registerResult'); 
    const txPromise = contract.register(uplineCode, position, { value: ENTRY_FEE }); 
    const receipt = await handleTx(txPromise, 'registerResult'); 
    showStatus('âœ… '+(lang==='en'?'Registration successful':'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚'), 'success', 'registerResult'); 
    await loadDashboard(); 
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'registerResult'); } 
}

async function contribute(){ 
  const amount = document.getElementById('contribution').value; 
  if(!amount || amount <= 0){ alert(lang==='en'?'Enter valid amount':'Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; } 
  try{ showStatus('ğŸ”„ '+(lang==='en'?'Sending contribution...':'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…Ø´Ø§Ø±Ú©Øª...'), 'info', 'minerResult'); 
    const txPromise = contract.contributeToMinerPool({ value: ethers.parseEther(amount) }); 
    await handleTx(txPromise, 'minerResult'); 
    showStatus('âœ… '+(lang==='en'?'Contribution success':'Ù…Ø´Ø§Ø±Ú©Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult'); 
    await loadDashboard(); 
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'minerResult'); } 
}

async function buyTokens(){ 
  try{ showStatus('ğŸ”„ '+(lang==='en'?'Buying tokens...':'Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù†...'), 'info', 'minerResult'); 
    const txPromise = contract.buyMinerTokens(); 
    await handleTx(txPromise, 'minerResult'); 
    showStatus('âœ… '+(lang==='en'?'Purchase successful':'Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult'); 
    await loadDashboard(); 
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'minerResult'); } 
}

async function distribute(){ 
  try{ showStatus('ğŸ”„ '+(lang==='en'?'Distributing tokens...':'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§...'), 'info', 'minerResult'); 
    const txPromise = contract.distributeMinerTokens(); 
    await handleTx(txPromise, 'minerResult'); 
    showStatus('âœ… '+(lang==='en'?'Distributed':'ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult'); 
    await loadDashboard(); 
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'minerResult'); } 
}

/* ================ Withdraw (pre-checks) ================ */
async function withdrawPool(){
  try{
    showStatus('ğŸ”„ '+(lang==='en'?'Checking pool withdraw conditions...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ø¨Ø±Ø¯Ø§Ø´Øª...'), 'info', 'withdrawResult');
    const check = await canWithdrawPool();
    if(!check.ok){
      showStatus(`â›” ${check.reason}`, 'error', 'withdrawResult');
      const btn = document.getElementById('withdrawMainBtn'); btn.classList.add('disabled'); setTimeout(()=>btn.classList.remove('disabled'), 4000);
      return;
    }
    showStatus('ğŸ”„ '+(lang==='en'?'Withdrawing main pool...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±...'), 'info', 'withdrawResult');
    const txPromise = contract.withdrawPool();
    await handleTx(txPromise, 'withdrawResult');
    showStatus('âœ… '+(lang==='en'?'Withdraw success':'Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'withdrawResult');
    await loadDashboard();
  }catch(err){
    console.error('withdrawPool error', err);
    showStatus('âŒ '+(err && err.message ? err.message : (lang==='en'?'Withdraw failed':'Ø¨Ø±Ø¯Ø§Ø´Øª Ù†Ø§Ù…ÙˆÙÙ‚')) , 'error', 'withdrawResult');
  }
}

async function withdrawSpecial(){
  try{
    const eligible = await contract.eligibleSpecialUserCount().catch(()=>0);
    if(Number(eligible) === 0){
      showStatus((lang==='en'?'No eligible special rewards for you at this time':'Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'), 'error', 'withdrawResult');
      const btn = document.getElementById('withdrawSpecialBtn'); btn.classList.add('disabled'); setTimeout(()=>btn.classList.remove('disabled'), 4000);
      return;
    }
    showStatus('ğŸ”„ '+(lang==='en'?'Withdrawing special...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡...'), 'info', 'withdrawResult');
    const txPromise = contract.withdrawSpecials();
    await handleTx(txPromise, 'withdrawResult');
    showStatus('âœ… '+(lang==='en'?'Special withdrawn':'Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø¯Ø§Ø´Øª Ø´Ø¯'), 'success', 'withdrawResult');
    await loadDashboard();
  }catch(err){ console.error('withdrawSpecial error', err); showStatus('âŒ '+(err.message || (lang==='en'?'Special withdraw failed':'Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚')), 'error', 'withdrawResult'); }
}

/* ================ Timers (in Actions tab) ================ */
let poolTimerInterval = null;
function startPoolTimer(lastWithdrawUnix = 0, cycleDurationSec = 0){
  if(poolTimerInterval) clearInterval(poolTimerInterval);
  function render(){
    const now = Math.floor(Date.now()/1000);
    const nextUnlock = (lastWithdrawUnix && cycleDurationSec) ? (lastWithdrawUnix + cycleDurationSec) : 0;
    let remaining = nextUnlock > now ? nextUnlock - now : 0;
    const lastDate = lastWithdrawUnix ? new Date(lastWithdrawUnix*1000).toUTCString() : 'â€”';
    document.getElementById('poolTimerLabel').textContent = `${t('last_pool_label')}: ${ lastWithdrawUnix ? lastDate : 'â€”' }`;
    const segContainer = document.getElementById('poolTimerSegments');
    const withdrawBtn = document.getElementById('withdrawMainBtn');
    if(remaining === 0){
      segContainer.innerHTML = `<div style="font-weight:700;color:var(--success)">${lang==='en'?'Withdrawable Now':'Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ú©Ù†ÙˆÙ†'}</div>`;
      withdrawBtn.classList.remove('disabled');
    } else {
      const days = Math.floor(remaining / 86400); remaining %= 86400;
      const hours = Math.floor(remaining / 3600); remaining %= 3600;
      const minutes = Math.floor(remaining / 60);
      const seconds = remaining % 60;
      segContainer.innerHTML = `<div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
                                <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
                                <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
                                <div class="time-segment"><div class="time-value">${String(seconds).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Sec':'Ø«Ø§Ù†ÛŒÙ‡'}</div></div>`;
      withdrawBtn.classList.add('disabled');
    }
  }
  render();
  poolTimerInterval = setInterval(render, 1000);
}

let specialTimerInterval = null;
function startSpecialTimer(){
  if(specialTimerInterval) clearInterval(specialTimerInterval);
  function renderSpecial(){
    const now = new Date();
    const year = now.getUTCFullYear();
    const month = now.getUTCMonth();
    const day = now.getUTCDate();
    let target;
    if(day < 3 || (day === 3 && now.getUTCHours() < 24)) target = new Date(Date.UTC(year, month, 3, 0, 0, 0));
    else target = new Date(Date.UTC(year, month+1, 3, 0, 0, 0));
    let diff = Math.floor((target - now) / 1000);
    if(diff < 0) diff = 0;
    const days = Math.floor(diff / 86400); diff %= 86400;
    const hours = Math.floor(diff / 3600); diff %= 3600;
    const minutes = Math.floor(diff / 60); const seconds = diff % 60;
    const seg = document.getElementById('specialTimerSegments');
    seg.innerHTML = `<div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
                     <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
                     <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
                     <div class="time-segment"><div class="time-value">${String(seconds).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Sec':'Ø«Ø§Ù†ÛŒÙ‡'}</div></div>`;
  }
  renderSpecial();
  specialTimerInterval = setInterval(renderSpecial, 1000);
}

/* ================ Dashboard loader (unchanged logic) ================ */
async function loadDashboard(){
  if(!contract) return;
  try{
    const [poolBalance, minerPool, specialPool, entryFee, lastPoolWithdrawTime, cycleDuration] = await Promise.all([
      contract.poolBalance().catch(()=>0),
      contract.minerTokenPool().catch(()=>0),
      contract.specialRewardPool().catch(()=>0),
      contract.ENTRY_FEE().catch(()=>ENTRY_FEE),
      contract.lastPoolWithdrawTime().catch(()=>0),
      contract.CYCLE_DURATION().catch(()=>0)
    ]);

    document.getElementById('poolBalance').textContent = (ethers.formatEther(poolBalance).substring(0,12) || '0') + ' MATIC';
    document.getElementById('minerPool').textContent = (ethers.formatEther(minerPool).substring(0,12) || '0') + ' pToken';
    document.getElementById('specialPool').textContent = (ethers.formatEther(specialPool).substring(0,12) || '0') + ' MATIC';
    document.getElementById('entryFeeDisplay').textContent = (ethers.formatEther(entryFee) || '0') + ' MATIC';

    // timers (actions tab)
    startPoolTimer(Number(lastPoolWithdrawTime), Number(cycleDuration));
    startSpecialTimer();

    const userInfo = await contract.getUserInfo(userAddress).catch(()=>null);
    if(userInfo){
      const userId = Number(userInfo[0]);
      showStatus(`<strong>ğŸ‘¤ ${lang==='en'?'User #':'Ú©Ø§Ø±Ø¨Ø± #'}${userId}</strong><br>ğŸ“Š ${lang==='en'?'Balance':'Ù…ÙˆØ¬ÙˆØ¯ÛŒ'}: ${userInfo[6]}<br>ğŸ ${lang==='en'?'Specials':'Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡'}: ${userInfo[7]}<br>â›ï¸ ${userInfo[10] ? 'âœ…':'âŒ'}<br>ğŸ’° ${lang==='en'?'Total rewards':'Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§'}: ${ethers.formatEther(userInfo[8])} MATIC`, 'success', 'userInfo');
      await loadTreeStructure(userId);
      const owner = await contract.owner().catch(()=>null);
      if(owner && owner.toLowerCase() === userAddress.toLowerCase()){ isOwner = true; document.getElementById('adminTab').style.display = 'block'; }
    }
  }catch(e){ console.error('loadDashboard error', e); }
}

/* ================ Connect wallet (unchanged logic) ================ */
async function connectWallet(){
  if(typeof window.ethereum === 'undefined'){ showStatus('âŒ '+(lang==='en'?'Wallet (MetaMask) not found':'Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ù…Ø«Ù„ MetaMask) ÛŒØ§ÙØª Ù†Ø´Ø¯'),'error'); return; }
  try{
    showLoading(true);
    showStatus('ğŸ”— '+(lang==='en'?'Connecting...':'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...'), 'info');
    const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
    userAddress = accounts[0];
    const chainId = await window.ethereum.request({ method:'eth_chainId' });
    if(chainId !== POLYGON_CHAIN_ID){
      showStatus('ğŸ”„ '+(lang==='en'?'Switching to Polygon...':'ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Polygon...'),'info');
      try{ await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: POLYGON_CHAIN_ID }]}); }catch(e){ if(e.code === 4902){ await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: POLYGON_CHAIN_ID, chainName:'Polygon Mainnet', nativeCurrency:{ name:'MATIC', symbol:'MATIC', decimals:18 }, rpcUrls:['https://polygon-rpc.com'], blockExplorerUrls:['https://polygonscan.com'] }]}); } }
      await new Promise(r=>setTimeout(r,1200));
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    document.getElementById('connectArea').innerHTML = `<div style="background:linear-gradient(90deg,#10b981,#34d399);color:#06281a;padding:10px;border-radius:8px;font-weight:700">âœ… ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}</div>`;
    updateNetworkStatus(true);
    await loadDashboard();
    showStatus('âœ… '+(lang==='en'?'Wallet connected':'Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯'), 'success');
    window.ethereum.on('accountsChanged', ()=> location.reload());
    window.ethereum.on('chainChanged', ()=> location.reload());
  }catch(err){ showStatus('âŒ '+err.message, 'error'); }finally{ showLoading(false); }
}
document.getElementById('connectBtn').onclick = connectWallet;

/* ================ Tabs ================ */
function showTab(tabName){
  const tabs = ['dashboard','register','miner','actions','admin'];
  tabs.forEach(t => document.getElementById(t+'Tab').style.display = 'none');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabName + 'Tab').style.display = 'block';
  document.querySelectorAll('.tab-btn').forEach(b=>{
    if(b.textContent.trim() === (lang==='en'? translations.en[tabName] : translations.fa[tabName])) b.classList.add('active');
  });
  if(tabName === 'dashboard') loadDashboard();
}

/* ================ Logo flip cycle (SPS <-> $) - robust via transform & opacity ================ */
const logoCard = document.getElementById('logoCard');
const logoFront = document.getElementById('logoFront');
const logoBack = document.getElementById('logoBack');

let logoCycleInterval = null;
function showFront(){
  logoFront.style.transform = 'rotateY(0deg) translateZ(0)';
  logoFront.style.opacity = '1';
  logoBack.style.transform = 'rotateY(180deg) translateZ(0)';
  logoBack.style.opacity = '0';
  logoCard.style.transform = 'rotateY(0deg)';
}
function showBack(){
  logoFront.style.transform = 'rotateY(-180deg) translateZ(0)';
  logoFront.style.opacity = '0';
  logoBack.style.transform = 'rotateY(0deg) translateZ(0)';
  logoBack.style.opacity = '1';
  logoCard.style.transform = 'rotateY(180deg)';
}
function startLogoCycle(){
  // start with SPS visible
  showFront();
  // flip every 3s: show back ($) for 2s, then back to front
  logoCycleInterval = setInterval(()=>{
    showBack();
    setTimeout(()=> showFront(), 2000);
  }, 3000);
}

/* ================ Init visuals & logo, and optional autorun connect ================ */
window.onload = function(){
  startVisuals();
  startLogoCycle();
  setLanguage();
  document.getElementById('connectBtn').onclick = connectWallet;
  // auto-connect if previously authorized
  if(typeof window.ethereum !== 'undefined'){
    window.ethereum.request({ method:'eth_accounts' }).then(accounts=>{
      if(accounts.length > 0) setTimeout(()=> connectWallet(), 800);
    });
  }

  // resize canvases
  resizeNeon(); resizeConfetti();
};
</script>
</body>
</html>