<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SPS DApp - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ (FA/EN)</title>

    <!-- ethers.js (Ù‡Ù…Ø§Ù† Ù†Ø³Ø®Ù‡) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

    <style>
        /* ====== Variables ====== */
        :root{
            --primary: #3b82f6;
            --accent: #8b5cf6;
            --neon: #00ffd5;
            --bg-1: #05060a;
            --card-bg: rgba(8,12,22,0.7);
            --muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        html[dir="rtl"]{ direction: rtl; }
        html[dir="ltr"]{ direction: ltr; }

        body{
            font-family: Tahoma, Arial, sans-serif;
            background: radial-gradient(1200px 600px at 10% 10%, rgba(139,92,246,0.08), transparent),
                        radial-gradient(1000px 500px at 90% 90%, rgba(59,130,246,0.04), transparent),
                        linear-gradient(180deg,#030416 0%, #081028 100%);
            color: #e6eef8;
            min-height:100vh;
            padding:20px;
        }

        .container{ max-width:1200px; margin:0 auto; position:relative; }

        /* flashy header gradient animation */
        .header{
            display:flex; align-items:center; justify-content:space-between; gap:12px;
            background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.03);
            box-shadow: 0 6px 30px rgba(59,130,246,0.06);
            position:relative; overflow:hidden;
        }
        .header:before{
            content:""; position:absolute; inset:-50% -30%; background:linear-gradient(120deg, rgba(59,130,246,0.05), rgba(139,92,246,0.06), rgba(0,255,213,0.02));
            transform:rotate(25deg); animation:slow-slide 10s linear infinite;
        }
        @keyframes slow-slide { from{transform:rotate(25deg) translateX(-10%)} to{transform:rotate(25deg) translateX(10%)} }

        .logo{ font-weight:900; font-size:20px; background: linear-gradient(90deg,var(--primary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent }
        .status-ind{ display:flex; gap:10px; align-items:center }
        .status-dot{ width:12px; height:12px; border-radius:50%; background:var(--danger); box-shadow:0 0 10px rgba(239,68,68,0.3) }
        .status-dot.connected{ background:var(--success); box-shadow:0 0 14px rgba(16,185,129,0.3) }
        .network-text{ font-weight:700; color:var(--muted) }

        /* language toggle */
        .lang-switch{ display:flex; gap:8px; align-items:center }
        .lang-btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); cursor:pointer; background:transparent; color:var(--muted); font-weight:700 }
        .lang-btn.active{ background:linear-gradient(90deg,var(--primary),var(--accent)); color:#081226; box-shadow:0 8px 26px rgba(59,130,246,0.18) }

        /* tabs */
        .tabs{ display:flex; gap:8px; margin:16px 0; flex-wrap:wrap }
        .tab-btn{ padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.02); color:var(--muted); cursor:pointer; font-weight:700 }
        .tab-btn.active{ background:linear-gradient(90deg, rgba(59,130,246,0.14), rgba(139,92,246,0.08)); color:var(--primary); box-shadow:0 10px 30px rgba(59,130,246,0.06) }

        /* stats grid */
        .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin:14px 0 }
        .stat-box{
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.03);
            position:relative; overflow:hidden;
        }
        /* neon number pulse */
        .stat-value{ font-weight:900; font-size:18px; color:#cfe7ff; text-shadow:0 0 12px rgba(59,130,246,0.12) }
        .stat-label{ color:var(--muted); font-size:13px }

        /* glowing accent */
        .glow-accent{ position:absolute; right:-60px; top:-40px; width:180px; height:180px; background: radial-gradient(circle at 30% 20%, rgba(59,130,246,0.18), transparent 30%), radial-gradient(circle at 70% 80%, rgba(139,92,246,0.12), transparent 20%); filter: blur(18px); transform:rotate(10deg); pointer-events:none }

        /* grid 2 */
        .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:12px }
        .card{ background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); position:relative; overflow:hidden }

        /* flashy animations: neon pulse */
        .neon-pulse{ animation:neon 2s ease-in-out infinite; }
        @keyframes neon { 0%{ box-shadow: 0 0 6px rgba(59,130,246,0.12)} 50%{ box-shadow: 0 0 18px rgba(59,130,246,0.22)} 100%{ box-shadow: 0 0 6px rgba(59,130,246,0.12)} }

        /* tree */
        .tree-container{ max-height:520px; overflow:auto; padding:10px; border-radius:8px; background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent) }
        .node{ padding:10px; border-radius:10px; margin-bottom:10px; background: rgba(8,12,22,0.6); border:1px solid rgba(59,130,246,0.08); display:flex; justify-content:space-between; align-items:center; gap:8px; transition:transform 0.28s, box-shadow 0.28s }
        .node:hover{ transform: translateY(-6px) scale(1.01); box-shadow: 0 12px 40px rgba(59,130,246,0.06) }
        .meta{ color:var(--muted); font-size:13px; }

        .children{ margin-right:16px; padding-right:12px; border-right:2px dashed rgba(59,130,246,0.06) }
        .toggle-btn{ background:transparent;border:1px solid rgba(255,255,255,0.03); padding:6px 8px; border-radius:8px; color:var(--primary); cursor:pointer; font-weight:700 }

        /* forms */
        .form-group{ margin-bottom:12px }
        .form-label{ color:var(--muted); font-size:13px; margin-bottom:6px; display:block }
        input[type="text"], input[type="number"], select, textarea{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit }

        /* buttons */
        .btn{ padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:800 }
        .btn-primary{ background:linear-gradient(90deg,var(--primary),var(--accent)); color:white; box-shadow:0 10px 30px rgba(59,130,246,0.08) }
        .btn-success{ background:linear-gradient(90deg,var(--success),#34d399); color:#02160f }
        .btn-warning{ background:linear-gradient(90deg,#f59e0b,#fbbf24); color:#2b1600 }
        .btn-danger{ background:linear-gradient(90deg,var(--danger),#f87171); color:#2b0e0e }

        .btn-group{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px }

        /* status */
        .status{ padding:12px; border-radius:8px; margin-top:10px; font-weight:800; text-align:center }
        .status.info{ background: rgba(59,130,246,0.06); color:#60a5fa; border:1px solid rgba(59,130,246,0.06) }
        .status.success{ background: rgba(16,185,129,0.06); color:#34d399; border:1px solid rgba(16,185,129,0.06) }
        .status.error{ background: rgba(239,68,68,0.06); color:#fb7185; border:1px solid rgba(239,68,68,0.06) }
        .tx-link{ color:#9ecbff; text-decoration:none; padding:6px 10px; display:inline-block; margin-top:8px; border-radius:6px; border:1px solid rgba(59,130,246,0.06) }

        /* countdown card (graphic) */
        .countdown{
            display:flex; align-items:center; gap:10px; justify-content:center; padding:12px; border-radius:12px;
            background:linear-gradient(90deg, rgba(59,130,246,0.06), rgba(139,92,246,0.04));
            border:1px solid rgba(255,255,255,0.03);
            box-shadow: 0 16px 40px rgba(139,92,246,0.06);
            font-weight:900;
        }
        .time-segment{ display:flex; flex-direction:column; align-items:center; padding:8px 10px; border-radius:8px; background:rgba(0,0,0,0.3) }
        .time-value{ font-size:18px; color:#cfe7ff; text-shadow:0 0 8px rgba(59,130,246,0.12) }
        .time-label{ font-size:12px; color:var(--muted) }

        /* loading overlay */
        .loading{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center }
        .spinner{ width:76px; height:76px; border-radius:50%; border:6px solid rgba(255,255,255,0.06); border-top-color:var(--neon); animation:spin 1s linear infinite }
        @keyframes spin { to{ transform:rotate(360deg) } }

        footer{ margin-top:22px; text-align:center; color:var(--muted); font-size:13px }

        /* confetti canvas */
        #confetti { position:fixed; inset:0; pointer-events:none; z-index:10000; display:none }

        /* responsive */
        @media (max-width:900px){ .grid-2{ grid-template-columns:1fr } .header{ flex-direction:column; align-items:flex-start } }
    </style>
</head>
<body>
    <canvas id="confetti"></canvas>
    <div class="container">
        <!-- header -->
        <div class="header">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="logo">SPS</div>
                <div class="status-ind">
                    <div id="statusDot" class="status-dot"></div>
                    <div id="networkStatus" class="network-text">Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡</div>
                </div>
            </div>

            <div style="display:flex;align-items:center;gap:12px">
                <div class="lang-switch" role="tablist" aria-label="Language switch">
                    <button id="btn-fa" class="lang-btn">FA</button>
                    <button id="btn-en" class="lang-btn">EN</button>
                </div>
                <div id="connectArea">
                    <button id="connectBtn" class="btn-primary btn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
                </div>
            </div>
        </div>

        <!-- tabs -->
        <div class="tabs" id="tabsRow">
            <button class="tab-btn active" onclick="showTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="tab-btn" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
            <button class="tab-btn" onclick="showTab('miner')">Ù…Ø§ÛŒÙ†Ø±</button>
            <button class="tab-btn" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª</button>
            <button class="tab-btn" onclick="showTab('admin')" id="adminTab" style="display:none">Ù…Ø¯ÛŒØ±ÛŒØª</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboardTab">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="glow-accent"></div>
                    <div class="stat-label" id="label-poolBalance">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±</div>
                    <div class="stat-value neon-pulse" id="poolBalance">0 MATIC</div>
                </div>

                <div class="stat-box">
                    <div class="stat-label" id="label-minerPool">Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±</div>
                    <div class="stat-value neon-pulse" id="minerPool">0 pToken</div>
                </div>

                <div class="stat-box">
                    <div class="stat-label" id="label-specialPool">Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</div>
                    <div class="stat-value" id="specialPool">0 MATIC</div>
                </div>

                <div class="stat-box">
                    <div class="stat-label" id="label-entryFee">Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯</div>
                    <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h3 id="h-userinfo">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
                    <div id="userInfo" class="status info">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</div>
                    <div class="help" id="help-userinfo">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ù„ÛŒÙ†Ú© ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>

                    <div style="margin-top:12px">
                        <div id="lastPoolTimerCard" class="countdown" title="Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø¹Ø¯ÛŒ Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ">
                            <div style="font-size:13px" id="lastPoolLabel">Ø§Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª: -</div>
                            <div id="poolTimerSegments" style="display:flex;gap:6px;margin-left:12px"></div>
                        </div>

                        <div style="height:12px"></div>

                        <div id="specialWithdrawCard" class="countdown" title="Ø²Ù…Ø§Ù† ØªØ§ Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡ (3rd UTC)">
                            <div style="font-weight:700;margin-right:12px" id="specialLabel">Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ</div>
                            <div id="specialTimerSegments" style="display:flex;gap:6px"></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 id="h-tree">ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø´Ù…Ø§</h3>
                    <div class="tree-container" id="treeContainer">
                        <div class="node">ğŸ”„ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯</div>
                    </div>
                    <div class="help" id="help-tree">Ø±ÙˆÛŒ Ù‡Ø± Ú¯Ø±Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù† ØªØ§ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ø´ÙˆÙ†Ø¯ â€” ØªØ¹Ø¯Ø§Ø¯ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§ Ú©Ù†Ø§Ø± Ù‡Ø± Ú¯Ø±Ù‡ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
                </div>
            </div>
        </div>

        <!-- Register -->
        <div id="registerTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3 id="h-register">ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
                    <div class="form-group">
                        <label class="form-label" id="label-upline">Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†</label>
                        <input id="uplineCode" class="form-input" type="number" placeholder="1" />
                    </div>
                    <div class="form-group">
                        <label class="form-label" id="label-position">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
                        <select id="position" class="form-input">
                            <option value="true">Ú†Ù¾</option>
                            <option value="false">Ø±Ø§Ø³Øª</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="register()" id="btn-register">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
                    <div id="registerResult"></div>
                </div>

                <div class="card">
                    <h3 id="h-reginfo">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
                    <div id="registerInfo" class="status info">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                </div>
            </div>
        </div>

        <!-- Miner -->
        <div id="minerTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3 id="h-miner">â›ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
                    <div class="form-group">
                        <label class="form-label" id="label-contribution">Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)</label>
                        <input id="contribution" class="form-input" placeholder="0.1" />
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="contribute()" id="btn-contrib">Ù…Ø´Ø§Ø±Ú©Øª</button>
                        <button class="btn btn-primary" onclick="buyTokens()" id="btn-buy">Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±</button>
                        <!-- ÙØ±ÙˆØ´ Ø§Ø² UI Ø­Ø°Ù Ø´Ø¯Ù‡ -->
                        <button class="btn btn-success" onclick="distribute()" id="btn-distrib">ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</button>
                    </div>

                    <div id="minerResult"></div>
                </div>

                <div class="card">
                    <h3 id="h-minerinfo">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
                    <div id="minerInfo" class="status info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§</div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div id="actionsTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3 id="h-actions">ğŸ’¸ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±Ù‡Ø§</h3>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ</button>
                        <button class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</button>
                    </div>
                    <div id="withdrawResult"></div>
                </div>

                <div class="card">
                    <h3 id="h-withdrawinfo">ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
                    <div id="withdrawInfo" class="status info">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</div>
                </div>
            </div>
        </div>

        <!-- Admin -->
        <div id="adminTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3 id="h-admin">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
                    <div class="form-group">
                        <label class="form-label" id="label-newFee">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ (wei)</label>
                        <input id="newFee" class="form-input" placeholder="300000000000000000000" />
                    </div>
                    <button class="btn btn-danger" onclick="updateFee()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯</button>
                    <div id="adminResult"></div>
                </div>

                <div class="card">
                    <h3 id="h-admin2">ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</h3>
                    <div class="form-group">
                        <label class="form-label" id="label-addresses">Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§)</label>
                        <textarea id="addresses" class="form-input" rows="4" placeholder="0x123...,0x456..."></textarea>
                    </div>
                    <button class="btn btn-danger" onclick="removeMiners()">Ø­Ø°Ù Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading"><div class="spinner"></div></div>

        <footer id="footerText">SPS Network â€¢ Ø¢Ø¯Ø±Ø³ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: 0x7a7b06D49129B34976D07B3854d4D72D01588191 â€¢ Polygon Mainnet</footer>
    </div>

    <script>
        /***************
         * ØªØ±Ø¬Ù…Ù‡â€ŒÙ‡Ø§ Ùˆ Ø³ÙˆØ¦ÛŒÚ† Ø²Ø¨Ø§Ù† (FA/EN LTR)
         * ØªÙ…Ø§Ù… Ù…ØªÙ†â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø§ÛŒÙ† Ø¢Ø¨Ø¬Ú©Øª Ù‡Ø³ØªÙ†Ø¯ â€” ØªØºÛŒÛŒØ±Ø§Øª UI ÙÙ‚Ø· Ù…ØªÙ†/Ø¬Ù‡Øª Ø±Ø§ Ø¹ÙˆØ¶ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
         ***************/
        const translations = {
            fa: {
                dashboard: "Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯", register: "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…", miner: "Ù…Ø§ÛŒÙ†Ø±", actions: "Ø¹Ù…Ù„ÛŒØ§Øª", admin: "Ù…Ø¯ÛŒØ±ÛŒØª",
                connect_wallet: "Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„", pool_balance: "Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±", miner_pool: "Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±",
                special_pool: "Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡", entry_fee: "Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯", user_info: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ",
                tree_title: "Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø´Ù…Ø§", register_label: "Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†", position: "Ù…ÙˆÙ‚Ø¹ÛŒØª",
                contribution: "Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)", buy_miner: "Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±", distribute: "ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§",
                withdraw_pool: "Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ", withdraw_special: "Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡",
                last_pool_label: "Ø§Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª", special_label: "Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ",
                registration_fee_text: "Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)", miner_info: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§",
                pool_timer_title: "Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡ ØªØ§ Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø¹Ø¯ÛŒ Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ"
            },
            en: {
                dashboard: "Dashboard", register: "Register", miner: "Miner", actions: "Actions", admin: "Admin",
                connect_wallet: "Connect Wallet", pool_balance: "Pool Balance", miner_pool: "Miner Pool",
                special_pool: "Special Reward", entry_fee: "Entry Fee", user_info: "User Info",
                tree_title: "Your Tree Structure", register_label: "Upline Code", position: "Position",
                contribution: "Contribution (MATIC)", buy_miner: "Buy Miner Token", distribute: "Distribute Tokens",
                withdraw_pool: "Withdraw Main Pool", withdraw_special: "Withdraw Special", last_pool_label: "Last Withdraw",
                special_label: "Next Special Withdraw", registration_fee_text: "Register (300 MATIC)", miner_info: "Your Miner Info",
                pool_timer_title: "Time until next main-pool withdraw"
            }
        };

        let lang = 'fa'; // default (user requested FA + EN support)
        function t(key){
            return translations[lang] && translations[lang][key] ? translations[lang][key] : key;
        }

        // ======= constants (unchanged logic) =======
        const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
        const POLYGON_CHAIN_ID = "0x89";
        const ENTRY_FEE = "300000000000000000000"; // 300 MATIC

        // === ABI unchanged ===
        const CONTRACT_ABI = [ /* full ABI (unchanged) */ 
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},
            {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"specialPointCount","stateMutability":"view","type":"function"},
            {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        // ===== state =====
        let provider, signer, contract, userAddress, isOwner = false;

        // ===== UI helpers =====
        function setLanguage(newLang){
            lang = newLang;
            // direction LTR for English, RTL for Persian
            document.documentElement.setAttribute('dir', newLang === 'en' ? 'ltr' : 'rtl');

            // swap texts
            document.querySelectorAll('[id]').forEach(el=>{
                // update specific known IDs
            });

            // update static labels
            document.querySelectorAll('#label-poolBalance, #label-minerPool, #label-specialPool, #label-entryFee').forEach(el=>{
                if (el.id === 'label-poolBalance') el.textContent = t('pool_balance');
                if (el.id === 'label-minerPool') el.textContent = t('miner_pool');
                if (el.id === 'label-specialPool') el.textContent = t('special_pool');
                if (el.id === 'label-entryFee') el.textContent = t('entry_fee');
            });

            // tabs
            const tabBtns = document.querySelectorAll('.tab-btn');
            if (newLang === 'fa'){
                tabBtns[0].textContent = translations.fa.dashboard;
                tabBtns[1].textContent = translations.fa.register;
                tabBtns[2].textContent = translations.fa.miner;
                tabBtns[3].textContent = translations.fa.actions;
                tabBtns[4].textContent = translations.fa.admin;
            } else {
                tabBtns[0].textContent = translations.en.dashboard;
                tabBtns[1].textContent = translations.en.register;
                tabBtns[2].textContent = translations.en.miner;
                tabBtns[3].textContent = translations.en.actions;
                tabBtns[4].textContent = translations.en.admin;
            }

            // header/labels/buttons
            document.getElementById('connectBtn').textContent = t('connect_wallet');
            document.getElementById('h-userinfo').textContent = t('user_info');
            document.getElementById('h-tree').textContent = t('tree_title');
            document.getElementById('h-register').textContent = t('register');
            document.getElementById('label-upline').textContent = t('register_label');
            document.getElementById('label-position').textContent = t('position');
            document.getElementById('btn-register').textContent = t('registration_fee_text');
            document.getElementById('h-miner').textContent = t('miner');
            document.getElementById('label-contribution').textContent = t('contribution');
            document.getElementById('btn-buy').textContent = t('buy_miner');
            document.getElementById('btn-distrib').textContent = t('distribute');
            document.getElementById('h-actions').textContent = t('actions');
            document.getElementById('h-admin').textContent = t('admin');

            document.getElementById('lastPoolLabel').textContent = `${t('last_pool_label')}:`;
            document.getElementById('specialLabel').textContent = t('special_label');

            // footer
            document.getElementById('footerText').textContent = `SPS Network â€¢ Contract: ${CONTRACT_ADDRESS} â€¢ Polygon Mainnet`;
        }

        document.getElementById('btn-fa').onclick = ()=>{ document.getElementById('btn-fa').classList.add('active'); document.getElementById('btn-en').classList.remove('active'); setLanguage('fa'); };
        document.getElementById('btn-en').onclick = ()=>{ document.getElementById('btn-en').classList.add('active'); document.getElementById('btn-fa').classList.remove('active'); setLanguage('en'); };

        // default UI language setup
        document.getElementById('btn-fa').classList.add('active');
        setLanguage('fa');

        // ===== raw UI helpers (unchanged logic functions reused) =====
        function showStatus(message, type='info', targetId='userInfo'){
            const el = document.getElementById(targetId);
            el.className = `status ${type}`;
            el.innerHTML = message;
            console.log(`[${type.toUpperCase()}] ${message.replace(/<[^>]*>/g,'')}`);
        }

        function showLoading(show){ document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        function showPending(txHash, targetId){
            const link = `https://polygonscan.com/tx/${txHash}`;
            document.getElementById(targetId).innerHTML = `
                <div class="status info">
                    â³ Transaction sent â€” pending...
                    <div style="margin-top:8px"><a href="${link}" target="_blank" class="tx-link">View on Polygonscan</a></div>
                </div>`;
        }

        function showTransactionLink(txHash, targetId){
            const link = `https://polygonscan.com/tx/${txHash}`;
            document.getElementById(targetId).innerHTML = `
                <div class="status success">
                    âœ… Transaction mined
                    <div style="margin-top:8px"><a href="${link}" target="_blank" class="tx-link">View on Polygonscan</a></div>
                </div>`;
        }

        function updateNetworkStatus(connected){
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('networkStatus');
            if(connected){ dot.classList.add('connected'); text.textContent = 'Polygon Mainnet'; }
            else { dot.classList.remove('connected'); text.textContent = lang === 'en' ? 'Network' : 'Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡'; }
        }

        // ===== confetti simple impl (visual, not necessary for logic) =====
        const confettiCanvas = document.getElementById('confetti');
        const confettiCtx = confettiCanvas.getContext ? confettiCanvas.getContext('2d') : null;
        let confettiPieces = [];
        function resizeConfetti(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeConfetti);
        function spawnConfetti(){
            if(!confettiCtx) return;
            confettiCanvas.style.display = 'block';
            for(let i=0;i<120;i++){
                confettiPieces.push({
                    x: Math.random()*confettiCanvas.width,
                    y: -Math.random()*confettiCanvas.height,
                    vx: (Math.random()-0.5)*6,
                    vy: 2 + Math.random()*6,
                    size: 6+Math.random()*8,
                    color: ['#3b82f6','#8b5cf6','#00ffd5','#ffb86b'][Math.floor(Math.random()*4)],
                    rot: Math.random()*360,
                    rotV: (Math.random()-0.5)*10
                });
            }
            let anim;
            function draw(){
                confettiCtx.clearRect(0,0,confettiCanvas.width, confettiCanvas.height);
                confettiPieces.forEach((p, i)=>{
                    confettiCtx.save();
                    confettiCtx.translate(p.x,p.y);
                    confettiCtx.rotate(p.rot*Math.PI/180);
                    confettiCtx.fillStyle = p.color;
                    confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
                    confettiCtx.restore();
                    p.x += p.vx; p.y += p.vy; p.rot += p.rotV;
                    if(p.y > confettiCanvas.height+50){ confettiPieces.splice(i,1); }
                });
                if(confettiPieces.length>0) anim = requestAnimationFrame(draw);
                else { cancelAnimationFrame(anim); confettiCanvas.style.display='none'; }
            }
            draw();
        }

        // ===== tree: multi-level with counts (uses contract._getSpecialUserInfoForMigrateToNewFork and getUserDirects) =====
        async function buildTreeHtml(nodeId, depth = 0, maxDepth = 5){
            try {
                if (depth > maxDepth) return '';
                // fetch counts via _getSpecialUserInfoForMigrateToNewFork which returns leftCount/rightCount
                let info = await contract._getSpecialUserInfoForMigrateToNewFork(nodeId).catch(()=>null);
                // get directs
                let directs = await contract.getUserDirects(nodeId).catch(()=>[0,0]);
                const leftId = directs[0] ? Number(directs[0]) : 0;
                const rightId = directs[1] ? Number(directs[1]) : 0;

                let leftCount = 0, rightCount = 0;
                if(info){
                    leftCount = info[2] ? Number(info[2]) : 0;
                    rightCount = info[3] ? Number(info[3]) : 0;
                }

                // node HTML
                let html = `<div class="node" data-id="${nodeId}" style="margin-${document.documentElement.dir === 'rtl' ? 'right' : 'left'}:${depth*12}px">`;
                html += `<div style="display:flex;flex-direction:column;gap:6px">`;
                html += `<div style="font-weight:800">ğŸ‘¤ ID: ${nodeId}</div>`;
                html += `<div class="meta">L: ${leftCount} | R: ${rightCount} | total: ${leftCount + rightCount}</div>`;
                html += `</div>`;
                if(leftId > 0 || rightId > 0){
                    html += `<div><button class="toggle-btn" data-target="${nodeId}">${lang==='en'?'[toggle]':'[Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡]'}</button></div>`;
                }
                html += `</div>`;

                if(leftId > 0 || rightId > 0){
                    html += `<div class="children" id="children-${nodeId}" style="display:none">`;
                    if(leftId > 0) html += await buildTreeHtml(leftId, depth+1, maxDepth);
                    if(rightId > 0) html += await buildTreeHtml(rightId, depth+1, maxDepth);
                    html += `</div>`;
                }
                return html;
            } catch (e){
                console.error('buildTreeHtml error', e);
                return `<div class="node">âš ï¸ Error loading node ${nodeId}</div>`;
            }
        }

        async function loadTreeStructure(userId){
            const container = document.getElementById('treeContainer');
            container.innerHTML = `<div class="node">ğŸ”„ ${lang==='en'?'Loading tree...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø±...'}</div>`;
            try {
                const html = await buildTreeHtml(userId);
                container.innerHTML = html || `<div class="node">ğŸ“­ ${lang==='en'?'No descendants':'Ù‡ÛŒÚ† Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'}</div>`;
                container.querySelectorAll('.toggle-btn').forEach(btn=>{
                    btn.onclick = ()=>{
                        const id = btn.getAttribute('data-target');
                        const el = document.getElementById('children-'+id);
                        if(!el) return;
                        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
                    };
                });
            } catch (err){
                console.error('loadTreeStructure error', err);
                container.innerHTML = `<div class="node">âš ï¸ ${lang==='en'?'Tree load error':'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø±'}</div>`;
            }
        }

        // ===== sellTokens kept (UI-hidden) - no logic changes =====
        async function sellTokens(){
            if(!contract){ alert(lang==='en'?'Please connect wallet':'Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯'); return; }
            try{
                showLoading(true);
                showStatus('ğŸ”„ '+(lang==='en'?'Processing sell...':'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ±ÙˆØ´ ØªÙˆÚ©Ù†...'), 'info', 'minerResult');
                await new Promise(r=>setTimeout(r,2000));
                showStatus('âš ï¸ '+(lang==='en'?'sell function not in contract':'ØªØ§Ø¨Ø¹ ÙØ±ÙˆØ´ ØªÙˆÚ©Ù† Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª'), 'error', 'minerResult');
            }catch(e){
                showStatus('âŒ '+e.message, 'error', 'minerResult');
            }finally{ showLoading(false); }
        }

        // ===== connect wallet (no logic change) =====
        async function connectWallet(){
            if(typeof window.ethereum === 'undefined'){ showStatus('âŒ '+(lang==='en'?'Wallet (MetaMask) not found':'Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ù…Ø«Ù„ MetaMask) ÛŒØ§ÙØª Ù†Ø´Ø¯'),'error'); return; }
            try{
                showLoading(true);
                showStatus('ğŸ”— '+(lang==='en'?'Connecting...':'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...'), 'info');
                const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
                userAddress = accounts[0];

                const chainId = await window.ethereum.request({ method:'eth_chainId' });
                if(chainId !== POLYGON_CHAIN_ID){
                    showStatus('ğŸ”„ '+(lang==='en'?'Switching to Polygon...':'ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Polygon...'),'info');
                    try{
                        await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: POLYGON_CHAIN_ID }]});
                    }catch(switchError){
                        if(switchError.code === 4902){
                            await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{
                                chainId: POLYGON_CHAIN_ID,
                                chainName: 'Polygon Mainnet',
                                nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                rpcUrls: ['https://polygon-rpc.com'],
                                blockExplorerUrls: ['https://polygonscan.com']
                            }]});
                        }
                    }
                    await new Promise(r=>setTimeout(r,1200));
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // update UI connect area
                document.getElementById('connectArea').innerHTML = `<div style="background:linear-gradient(90deg,#10b981,#34d399);color:#06281a;padding:10px;border-radius:8px;font-weight:700">âœ… ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}</div>`;

                updateNetworkStatus(true);
                await loadDashboard();
                showStatus('âœ… '+(lang==='en'?'Wallet connected':'Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯'), 'success');

                window.ethereum.on('accountsChanged', ()=> location.reload());
                window.ethereum.on('chainChanged', ()=> location.reload());

            }catch(err){
                showStatus('âŒ '+err.message, 'error');
            }finally{ showLoading(false); }
        }

        // ===== dashboard loader (minerPool displayed as pToken only) =====
        async function loadDashboard(){
            if(!contract) return;
            try{
                const [poolBalance, minerPool, specialPool, entryFee, lastPoolWithdrawTime, cycleDuration] = await Promise.all([
                    contract.poolBalance().catch(()=>0),
                    contract.minerTokenPool().catch(()=>0),
                    contract.specialRewardPool().catch(()=>0),
                    contract.ENTRY_FEE().catch(()=>ENTRY_FEE),
                    contract.lastPoolWithdrawTime().catch(()=>0),
                    contract.CYCLE_DURATION().catch(()=>0)
                ]);

                document.getElementById('poolBalance').textContent = (ethers.formatEther(poolBalance).substring(0,12) || '0') + ' MATIC';
                document.getElementById('minerPool').textContent = (ethers.formatEther(minerPool).substring(0,12) || '0') + ' pToken';
                document.getElementById('specialPool').textContent = (ethers.formatEther(specialPool).substring(0,12) || '0') + ' MATIC';
                document.getElementById('entryFeeDisplay').textContent = (ethers.formatEther(entryFee) || '0') + ' MATIC';

                // update pool timers (graphical)
                startPoolTimer(Number(lastPoolWithdrawTime), Number(cycleDuration));

                // special withdraw timer (3rd day of each month UTC)
                startSpecialTimer();

                // user info and tree
                const userInfo = await contract.getUserInfo(userAddress).catch(()=>null);
                if(userInfo){
                    const userId = Number(userInfo[0]);
                    showStatus(`<strong>ğŸ‘¤ ${lang==='en'?'User #':'Ú©Ø§Ø±Ø¨Ø± #'}${userId}</strong><br>ğŸ“Š ${lang==='en'?'Balance':'Ù…ÙˆØ¬ÙˆØ¯ÛŒ'}: ${userInfo[6]}<br>ğŸ ${lang==='en'?'Specials':'Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡'}: ${userInfo[7]}<br>â›ï¸ ${userInfo[10] ? 'âœ…':'âŒ'}<br>ğŸ’° ${lang==='en'?'Total rewards':'Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§'}: ${ethers.formatEther(userInfo[8])} MATIC`, 'success', 'userInfo');

                    // load tree recursively
                    await loadTreeStructure(userId);

                    // owner check
                    const owner = await contract.owner().catch(()=>null);
                    if(owner && owner.toLowerCase() === userAddress.toLowerCase()){
                        isOwner = true; document.getElementById('adminTab').style.display = 'block';
                    }
                }

            }catch(e){ console.error('loadDashboard error', e); }
        }

        // ===== timer helpers =====
        let poolTimerInterval = null;
        function startPoolTimer(lastWithdrawUnix = 0, cycleDurationSec = 0){
            // lastWithdrawUnix is in seconds from contract (unix)
            // cycleDurationSec is seconds for next withdraw cycle
            if(poolTimerInterval) clearInterval(poolTimerInterval);

            function render(){
                const now = Math.floor(Date.now()/1000);
                const nextUnlock = (lastWithdrawUnix && cycleDurationSec) ? (lastWithdrawUnix + cycleDurationSec) : 0;
                let remaining = nextUnlock > now ? nextUnlock - now : 0;
                // display last withdraw time
                const lastDate = lastWithdrawUnix ? new Date(lastWithdrawUnix*1000).toUTCString() : 'â€”';
                document.getElementById('lastPoolLabel').textContent = `${t('last_pool_label')}: ${ lastWithdrawUnix ? lastDate : 'â€”' }`;

                // fill segments
                const segContainer = document.getElementById('poolTimerSegments');
                if(remaining === 0){
                    segContainer.innerHTML = `<div style="font-weight:700;color:var(--success)">${lang==='en'?'Withdrawable Now':'Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ú©Ù†ÙˆÙ†'}</div>`;
                } else {
                    const days = Math.floor(remaining / 86400); remaining %= 86400;
                    const hours = Math.floor(remaining / 3600); remaining %= 3600;
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    segContainer.innerHTML = `
                        <div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
                        <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
                        <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
                        <div class="time-segment"><div class="time-value">${String(seconds).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Sec':'Ø«Ø§Ù†ÛŒÙ‡'}</div></div>
                    `;
                }
            }
            render();
            poolTimerInterval = setInterval(render, 1000);
        }

        let specialTimerInterval = null;
        function startSpecialTimer(){
            if(specialTimerInterval) clearInterval(specialTimerInterval);
            function renderSpecial(){
                const now = new Date();
                // target: 3rd day of this or next month at 00:00:00 UTC (user wanted "3 Ù…ÛŒÙ„Ø§Ø¯ÛŒ Ù‡Ø± Ù…Ø§Ù‡")
                const year = now.getUTCFullYear();
                const month = now.getUTCMonth(); // 0-index
                const day = now.getUTCDate();
                let target;
                if(day < 3 || (day === 3 && now.getUTCHours() < 24)) {
                    target = new Date(Date.UTC(year, month, 3, 0, 0, 0));
                } else {
                    target = new Date(Date.UTC(year, month+1, 3, 0, 0, 0));
                }
                let diff = Math.floor((target - now) / 1000);
                if(diff < 0) diff = 0;
                const days = Math.floor(diff / 86400); diff %= 86400;
                const hours = Math.floor(diff / 3600); diff %= 3600;
                const minutes = Math.floor(diff / 60); const seconds = diff % 60;

                const seg = document.getElementById('specialTimerSegments');
                seg.innerHTML = `
                    <div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
                    <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
                    <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
                    <div class="time-segment"><div class="time-value">${String(seconds).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Sec':'Ø«Ø§Ù†ÛŒÙ‡'}</div></div>
                `;
            }
            renderSpecial();
            specialTimerInterval = setInterval(renderSpecial, 1000);
        }

        // ===== tx handler helper (UI: pending + confetti on success) =====
        async function handleTx(txPromise, targetId){
            try{
                showLoading(true);
                const tx = await txPromise;
                showPending(tx.hash, targetId);
                const receipt = await tx.wait();
                showTransactionLink(tx.hash, targetId);
                // spawn confetti for success
                spawnConfetti();
                setTimeout(()=>{ confettiPieces = []; }, 5000);
                return receipt;
            }catch(err){
                document.getElementById(targetId).innerHTML = `<div class="status error">âŒ ${err.message}</div>`;
                throw err;
            }finally{
                showLoading(false);
            }
        }

        // ===== main action functions (logic unchanged) =====
        async function register(){
            const uplineCode = document.getElementById('uplineCode').value;
            const position = document.getElementById('position').value === 'true';
            if(!uplineCode){ alert(lang==='en'?'Please enter upline code':'Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Registering...':'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...'), 'info', 'registerResult');
                const txPromise = contract.register(uplineCode, position, { value: ENTRY_FEE });
                const receipt = await handleTx(txPromise, 'registerResult');
                showStatus('âœ… '+(lang==='en'?'Registration successful':'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚'), 'success', 'registerResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'registerResult');
            }
        }

        async function contribute(){
            const amount = document.getElementById('contribution').value;
            if(!amount || amount <= 0){ alert(lang==='en'?'Enter valid amount':'Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Sending contribution...':'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…Ø´Ø§Ø±Ú©Øª...'), 'info', 'minerResult');
                const txPromise = contract.contributeToMinerPool({ value: ethers.parseEther(amount) });
                await handleTx(txPromise, 'minerResult');
                showStatus('âœ… '+(lang==='en'?'Contribution success':'Ù…Ø´Ø§Ø±Ú©Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'minerResult');
            }
        }

        async function buyTokens(){
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Buying tokens...':'Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù†...'), 'info', 'minerResult');
                const txPromise = contract.buyMinerTokens();
                await handleTx(txPromise, 'minerResult');
                showStatus('âœ… '+(lang==='en'?'Purchase successful':'Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'minerResult');
            }
        }

        async function distribute(){
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Distributing tokens...':'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§...'), 'info', 'minerResult');
                const txPromise = contract.distributeMinerTokens();
                await handleTx(txPromise, 'minerResult');
                showStatus('âœ… '+(lang==='en'?'Distributed':'ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'minerResult');
            }
        }

        async function withdrawPool(){
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Withdrawing main pool...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±...'), 'info', 'withdrawResult');
                const txPromise = contract.withdrawPool();
                await handleTx(txPromise, 'withdrawResult');
                showStatus('âœ… '+(lang==='en'?'Withdraw success':'Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'withdrawResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'withdrawResult');
            }
        }

        async function withdrawSpecial(){
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Withdrawing special...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡...'), 'info', 'withdrawResult');
                const txPromise = contract.withdrawSpecials();
                await handleTx(txPromise, 'withdrawResult');
                showStatus('âœ… '+(lang==='en'?'Special withdrawn':'Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø¯Ø§Ø´Øª Ø´Ø¯'), 'success', 'withdrawResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'withdrawResult');
            }
        }

        async function updateFee(){
            if(!isOwner){ alert(lang==='en'?'Permission denied: owner only':'âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯: ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯'); return; }
            const newFee = document.getElementById('newFee').value;
            if(!newFee){ alert(lang==='en'?'Enter fee':'Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Updating fee...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯...'), 'info', 'adminResult');
                const txPromise = contract.updateEntryFee(newFee);
                await handleTx(txPromise, 'adminResult');
                showStatus('âœ… '+(lang==='en'?'Fee updated':'Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯'), 'success', 'adminResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'adminResult');
            }
        }

        async function removeMiners(){
            if(!isOwner){ alert(lang==='en'?'Permission denied: owner only':'âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯: ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯'); return; }
            const addressesText = document.getElementById('addresses').value;
            if(!addressesText){ alert(lang==='en'?'Enter addresses':'Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            const addresses = addressesText.split(',').map(a=>a.trim()).filter(a=>ethers.isAddress(a));
            if(addresses.length === 0){ alert(lang==='en'?'No valid addresses':'Ù‡ÛŒÚ† Ø¢Ø¯Ø±Ø³ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
            try{
                showStatus('ğŸ”„ '+(lang==='en'?'Removing miners...':'Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§...'), 'info', 'adminResult');
                const txPromise = contract.batchRemoveMiners(addresses);
                await handleTx(txPromise, 'adminResult');
                showStatus('âœ… '+(lang==='en'?'Removed':'Ø­Ø°Ù Ø´Ø¯Ù†Ø¯'), 'success', 'adminResult');
                await loadDashboard();
            }catch(err){
                showStatus('âŒ '+err.message, 'error', 'adminResult');
            }
        }

        // ===== tabs & init =====
        function showTab(tabName){
            const tabs = ['dashboard','register','miner','actions','admin'];
            tabs.forEach(t => document.getElementById(t + 'Tab').style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + 'Tab').style.display = 'block';
            // find corresponding button and set active by comparing translation
            document.querySelectorAll('.tab-btn').forEach(b=>{
                if(b.textContent.trim() === (lang==='en'? translations.en[tabName] : translations.fa[tabName])) b.classList.add('active');
            });
            if(tabName === 'dashboard') loadDashboard();
        }

        window.onload = function(){
            resizeConfetti();
            document.getElementById('connectBtn').onclick = connectWallet;
            // set initial text of connect button
            document.getElementById('connectBtn').textContent = t('connect_wallet');

            // auto connect if accounts exist
            if(typeof window.ethereum !== 'undefined'){
                window.ethereum.request({ method:'eth_accounts' }).then(accounts=>{
                    if(accounts.length > 0) setTimeout(()=> connectWallet(), 800);
                });
            }
        };
    </script>
</body>
</html>